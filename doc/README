/* README.ja */

名前
 hadoop-streaming - Hadoop Streaming Framework

書式
 bin/run

説明
 Hadoop Streaming を薄くラップする便利なフレームワーク。
 RSpec を利用してローカルでのテストを実施、その後 Hadoop で実行するのが目的。
 各種パラメータの環境設定やジョブの開始終了管理を一元的に管理する。


[環境設定]

1) 前提条件
ruby, rspec, hadoop のセットアップが完了していること。

2) テスト実行
$ cd ~/hadoop-streaming
$ rake spec

Mapper
  単語ごとの長さが返る

Reducer
  単語の平均の長さが返る

Finished in 2.74 seconds
3 examples, 0 failures
のように表示されることを確認する。


[実行方法]

まずは Hadoop を使わずに実行する。
script/simple で UNIX のパイプのみを使って実行できる。

$ script/simple

log/result.log
に平均単語長が出力されているはずなので確認する。

次項のサンプル出力例のようになっていれば OK である。


次に Hadoop Streaming 経由で実行する。

$ bin/run

log/job.log
log/result.log
内容を確認する。


[出力例]

キーと値は単語の頭文字及び平均の長さとなるはずである。

A	4.0587786986758125
B	5.366279646720254
C	7.070440120695037
D	5.408440499909437
E	6.327756653992395
F	5.476415731855656
G	6.1834578247403895
H	4.693269230769231
I	1.6818091844813936
J	5.350446428571429
K	4.726143790849673
L	5.426830937713895
M	5.701135486715907
N	4.459705372616984
O	3.1728779758195187
P	6.842238470191226
Q	5.671541057367829
R	6.696761249641731
S	5.590035529715762
T	4.163805104408353
U	5.43327067669173
V	5.412362404741744
W	4.753339801477722
X	3.8349514563106797
Y	3.7034035656401945
Z	7.333333333333333
a	3.223232413710737
b	4.531370107724787
c	6.519535922175265
d	5.279702194357367
e	5.88200407187749
f	5.1553103268144564
g	5.28028696194635
h	4.172764751352744
i	2.911377629927923
j	5.882282996432818
k	5.071448743292855
l	4.9887990043559425
m	4.007952123298901
n	4.025953275467462
o	3.0064305085693515
p	6.5711949201462385
q	6.541471962616822
r	6.340387212967132
s	5.231484427475519
t	3.9519012446363866
u	4.812600768944562
v	6.15426997245179
w	4.6133843607778235
y	3.7618880659157647
z	4.981132075471698


[詳細設定]

 config/env.conf では実行環境に即した様々な設定をおこなうことができる。
これにより実行環境の差異を吸収することができる。

# インストールされた Hadoop のルートディレクトリ
HADOOP_ROOT=/usr/local/hadoop

# Streaming 用の .jar ファイルの場所
HADOOP_JAR=$HADOOP_ROOT/contrib/streaming/hadoop-streaming-0.20.205.0.jar

# Hadoop の実行用バイナリのパス
HADOOP=$HADOOP_HOME/bin/hadoop

# ログの出力先
JOBLOG=$SCRIPT_HOME/log/job.log

このファイルは単にシェルスクリプトとして呼ばれるため、事前処理もそのまま記述できる。
詳細はファイルの内容を参照のこと。


[処理概要]

本ソフトウェアのファイル体系は以下の通りである。

.
|
+- bin
|   |
|   +- run
|        実行ファイル本体
|
+- config
|   |
|   +- env.conf
|        設定ファイル
|
+- doc
|   |
|   +- README
|        本ドキュメント
|
+- lib 処理に必要な主要なファイルが格納される
|   |
|   +- mapper.rb
|   |    Mapper
|   +- reducer.rb
|        Reducer
|
+- data
|   |
|   +- shakespeare
|        サンプルの入力データ例となるシェークスピアの作品集データ
|
+- log ログファイルが格納される
|   |
|   +- job.log
|   |    処理経過が出力されるログファイル
|   +- result.log
|        集計結果が格納されるログファイル
|
+- script シェルスクリプトが格納される
|   |
|   +- run
|   |    Hadoop Streaming に処理を受け渡すスクリプト本体
|   +- simple
|        Hadoop を経由せず UNIX パイプを利用する場合のスクリプト
|
+- spec RSpec によるテストコードが格納される
|
+- vendor 外部ライブラリ


[MapReduce]

Mapper と Reducer は標準入出力を扱うためホワイトボックステストが困難である。
そのためできるだけ処理を外部クラスに切り出し軽くする必要がある。


